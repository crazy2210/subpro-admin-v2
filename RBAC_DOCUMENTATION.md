# نظام التحكم بالصلاحيات (RBAC) - SubPro Dashboard

## نظرة عامة

تم تطبيق نظام شامل للتحكم في الصلاحيات (Role-Based Access Control) على لوحة SubPro Dashboard لضمان الأمان وتقسيم المسؤوليات بين أعضاء الفريق.

## الأدوار المتاحة (Roles)

### 1. المدير (Admin)
**الصلاحيات الكاملة** - مالك المشروع
- ✅ الوصول الكامل لجميع أجزاء النظام
- ✅ إدارة المستخدمين وتعيين الصلاحيات
- ✅ عرض وإدارة جميع البيانات (المبيعات، المصروفات، الأكونتات، المنتجات)
- ✅ حذف البيانات الحساسة
- ✅ تصدير البيانات
- ✅ الوصول لجميع التقارير والتحليلات
- ✅ معالجة المشاكل والشكاوى

### 2. قائد الفريق (Team Leader)
**إدارة الفريق ومراقبة الأداء**
- ✅ عرض جميع البيانات والتقارير
- ✅ إضافة وتعديل المبيعات والمصروفات
- ✅ إدارة الأكونتات والمنتجات
- ✅ تصدير البيانات
- ✅ إدارة تنبيهات التجديد
- ✅ معالجة المشاكل
- ❌ لا يمكن حذف المبيعات أو المصروفات
- ❌ لا يمكن إدارة المستخدمين

### 3. المشرف (Moderator)
**العمليات اليومية والتفاعل مع العملاء**
- ✅ عرض المبيعات والأكونتات
- ✅ إضافة مبيعات جديدة
- ✅ تأكيد المبيعات
- ✅ إدارة تنبيهات التجديد
- ❌ لا يمكن الوصول للمصروفات
- ❌ لا يمكن الوصول للتقارير المالية
- ❌ لا يمكن تعديل أو حذف البيانات
- ❌ لا يمكن تصدير البيانات
- ❌ لا يمكن إدارة المستخدمين

## مصفوفة الصلاحيات التفصيلية

| الصلاحية | المدير | قائد الفريق | المشرف |
|---------|--------|------------|---------|
| **عرض لوحة التحكم** | ✅ | ✅ | ✅ |
| **عرض التقارير** | ✅ | ✅ | ❌ |
| **عرض المبيعات** | ✅ | ✅ | ✅ |
| **إضافة مبيعات** | ✅ | ✅ | ✅ |
| **تعديل مبيعات** | ✅ | ✅ | ❌ |
| **حذف مبيعات** | ✅ | ❌ | ❌ |
| **تأكيد مبيعات** | ✅ | ✅ | ✅ |
| **عرض الأكونتات** | ✅ | ✅ | ✅ |
| **إضافة أكونتات** | ✅ | ✅ | ❌ |
| **تعديل أكونتات** | ✅ | ✅ | ❌ |
| **حذف أكونتات** | ✅ | ❌ | ❌ |
| **عرض المصروفات** | ✅ | ✅ | ❌ |
| **إضافة مصروفات** | ✅ | ✅ | ❌ |
| **تعديل مصروفات** | ✅ | ✅ | ❌ |
| **حذف مصروفات** | ✅ | ❌ | ❌ |
| **إضافة منتجات** | ✅ | ✅ | ❌ |
| **حذف منتجات** | ✅ | ❌ | ❌ |
| **معالجة المشاكل** | ✅ | ✅ | ❌ |
| **إدارة التجديدات** | ✅ | ✅ | ✅ |
| **تصدير البيانات** | ✅ | ✅ | ❌ |
| **إدارة المستخدمين** | ✅ | ❌ | ❌ |

## كيفية الاستخدام

### 1. تسجيل الدخول للمرة الأولى

1. افتح صفحة `login.html`
2. أول مستخدم يسجل في النظام يجب أن يحصل على صلاحيات **مدير** يدويًا من Firebase Console
3. المستخدمون الجدد سيحتاجون إلى موافقة المدير

### 2. إنشاء حساب جديد

1. اضغط على "إنشاء حساب جديد" في صفحة تسجيل الدخول
2. أدخل البيانات المطلوبة (الاسم، البريد الإلكتروني، كلمة المرور)
3. انتظر موافقة المدير وتعيين الصلاحيات

### 3. إدارة المستخدمين (للمدير فقط)

1. بعد تسجيل الدخول كمدير، ستجد زر "إدارة المستخدمين" في الزاوية
2. اضغط على الزر لفتح لوحة إدارة المستخدمين
3. يمكنك:
   - تعيين الصلاحيات (Admin, Team Leader, Moderator)
   - تفعيل أو تعطيل المستخدمين
   - حذف المستخدمين

### 4. تعيين أول مدير يدويًا

إذا كنت أول مستخدم، يجب تعيين صلاحية المدير يدويًا من Firebase Console:

1. افتح Firebase Console
2. اذهب إلى Firestore Database
3. ابحث عن collection اسمه `users`
4. افتح document المستخدم الخاص بك
5. غيّر الحقول التالية:
   ```
   role: "admin"
   isActive: true
   ```

## الملفات المضافة

### 1. `login.html`
صفحة تسجيل الدخول والتسجيل الجديدة مع:
- نموذج تسجيل دخول آمن
- نموذج إنشاء حساب جديد
- تصميم عصري وسهل الاستخدام

### 2. `auth.js`
نظام المصادقة والصلاحيات الذي يحتوي على:
- تعريفات الأدوار والصلاحيات
- دوال التحقق من الصلاحيات
- تطبيق القيود على واجهة المستخدم
- إدارة الجلسات

### 3. `users-management.js`
واجهة إدارة المستخدمين للمدير:
- عرض جميع المستخدمين
- تعيين وتغيير الصلاحيات
- تفعيل/تعطيل المستخدمين
- حذف المستخدمين

### 4. `RBAC_DOCUMENTATION.md`
هذا الملف - دليل شامل لنظام الصلاحيات

## التعديلات على الملفات الموجودة

### `app.js`
- إضافة استيراد modules الخاصة بالمصادقة
- إضافة فحص الصلاحيات قبل كل عملية
- دمج نظام المصادقة مع التطبيق الحالي

### `styles.css`
- إضافة classes لإخفاء العناصر بناءً على الصلاحيات
- تحسينات في التصميم للدعم الجديد

### `index.html`
لا تحتاج لتعديلات - النظام يعمل تلقائيًا!

## هيكل قاعدة البيانات (Firestore)

### Collection: `users`
```javascript
{
  uid: "firebase_user_id",
  name: "اسم المستخدم",
  email: "user@example.com",
  role: "admin" | "team_leader" | "moderator",
  isActive: true | false,
  createdAt: "ISO timestamp"
}
```

## الأمان

- ✅ جميع الصفحات محمية بنظام المصادقة
- ✅ المستخدمون غير المصرح لهم يتم إعادة توجيههم لصفحة تسجيل الدخول
- ✅ فحص الصلاحيات على مستوى الواجهة والعمليات
- ✅ المستخدمون المعطلون لا يمكنهم الوصول
- ✅ المستخدمون بدون صلاحيات مُعينة لا يمكنهم الوصول

## ملاحظات مهمة

1. **يجب تفعيل Email/Password Authentication في Firebase Console**
   - اذهب إلى Authentication > Sign-in method
   - فعّل Email/Password

2. **إنشاء قواعد Firestore Security Rules**
   ```javascript
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       // Users collection - only authenticated users can read their own data
       match /users/{userId} {
         allow read: if request.auth != null && request.auth.uid == userId;
         allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
       }
       
       // All other collections - authenticated users with active status
       match /{document=**} {
         allow read, write: if request.auth != null && 
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
       }
     }
   }
   ```

3. **النسخ الاحتياطي المنتظم**
   - قم بعمل نسخة احتياطية من قاعدة البيانات بانتظام
   - احتفظ بنسخة من بيانات المستخدمين

## استكشاف الأخطاء

### المشكلة: لا يمكن تسجيل الدخول
**الحل:**
- تأكد من تفعيل Email/Password في Firebase Authentication
- تحقق من صحة بيانات الدخول
- تأكد من أن الحساب مفعّل (`isActive: true`)

### المشكلة: "ليس لديك صلاحية"
**الحل:**
- تحقق من أن المدير قام بتعيين صلاحية لحسابك
- تأكد من أن دورك صحيح في Firestore
- تأكد من تفعيل حسابك

### المشكلة: لا يظهر زر "إدارة المستخدمين"
**الحل:**
- هذا الزر يظهر فقط للمديرين
- تحقق من أن `role: "admin"` في Firestore

## الدعم الفني

في حالة وجود مشاكل:
1. تحقق من console المتصفح للأخطاء
2. تأكد من إعدادات Firebase
3. راجع هذه الوثائق

## التحديثات المستقبلية المقترحة

- [ ] إضافة سجل للأنشطة (Activity Log)
- [ ] إضافة إشعارات للمديرين عند إنشاء حسابات جديدة
- [ ] إضافة صلاحيات مخصصة لكل مستخدم
- [ ] إضافة نظام الصلاحيات المؤقتة
- [ ] إضافة تقارير استخدام المستخدمين

---

**تم إنشاء النظام في:** 2025
**الإصدار:** 1.0
**آخر تحديث:** 2025-10-17
