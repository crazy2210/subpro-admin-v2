# خطة تطوير نظام SubPro Dashboard

## نظرة عامة
هذا المستند يوضح خطة تطوير شاملة لنظام SubPro Dashboard لتحويله إلى نظام اشتراكات احترافي متكامل.

## التعديلات المطلوبة

### 1. نظام التجديدات والاشتراكات ✅
**الوصف**: نظام متكامل لتتبع الاشتراكات مع حالات متعددة وتنبيهات تلقائية
**المتطلبات**:
- حقول جديدة في قاعدة البيانات: subscription_start, subscription_end, subscription_status, auto_renew
- حالات الاشتراك: نشط، قريب الانتهاء، منتهي، مجدد، ملغي
- تنبيهات قبل 48 ساعة من انتهاء الاشتراك
- تجديد يدوي وتلقائي
- ربط التجديدات بأوردرات جديدة من نوع "تجديد"

### 2. زر تجديد في إضافة الأوردر ✅
**الوصف**: إضافة وظيفة بحث وتجديد للاشتراكات القديمة
**المتطلبات**:
- زر "تجديد" في نموذج إضافة الأوردر
- شاشة بحث بالاسم، رقم الهاتف، الإيميل، رقم الأوردر، اسم المنتج
- إنشاء أوردر تجديد مرتبط بالعميل والاشتراك القديم

### 3. تحسين واجهة الأوردرات ✅
**الوصف**: جدول احترافي شبيه بـ Excel مع مميزات متقدمة
**المتطلبات**:
- جدول منظم مع Highlight عند الوقوف على الصف
- أزرار سريعة: عرض، تعديل، نسخ، فتح العميل
- بحث وفلاتر متقدمة: المنتج، الحالة، التاريخ، نوع الأوردر
- ترتيب الأعمدة وتصفيتها
- تصدير CSV/Excel
- ألوان مميزة لحالات الأوردر

### 4. إدارة الأكونتات المحسنة ✅
**الوصف**: واجهة Excel-like لإدارة الحسابات
**المتطلبات**:
- جدول: الإيميل، الباسورد، المنتج، الحالة، تاريخ الإضافة، تاريخ الانتهاء
- عدادات: متاح، مستخدم، تالف
- فلاتر سريعة: المنتج، الحالة
- بحث وتعديل سريع

### 5. نظام استبدال الحسابات التالفة ✅
**الوصف**: استبدال تلقائي للحسابات التالفة مع تسجيل كامل
**المتطلبات**:
- زر "وسم كتالف واستبدال" في تفاصيل الأوردر
- تحويل الحساب القديم لحالة "تالف"
- اختيار حساب بديل من نفس المنتج
- تحديث الأوردر بالحساب الجديد
- Audit log للعملية
- عرض مميز للحساب التالف (أحمر) والبديل (أخضر)
- رسالة خطأ إذا لم يتوفر حساب بديل

### 6. نظام التنبيهات الذكي ✅
**الوصف**: تنبيهات مرتبطة بالاشتراكات والأحداث
**المتطلبات**:
- تنبيهات الاشتراكات القريبة من الانتهاء
- إزالة التنبيه تلقائياً عند التجديد
- تقليل العداد عند فتح التنبيه
- أنواع: قرب انتهاء، فشل تجديد، مبالغ متبقية، تغيير حساب شهري

### 7. تتبع الدفع للأوردرات ✅
**الوصف**: نظام متابعة حالة الدفع لكل أوردر
**المتطلبات**:
- حقول: payment_status, amount_paid, amount_remaining
- حالات: مدفوع بالكامل، مدفوع جزئياً، غير مدفوع
- عرض المبلغ المتبقي
- تحديث الإحصائيات بناءً على حالة الدفع
- عرض في تفاصيل الأوردر والجدول

### 8. الاشتراكات طويلة المدة ✅
**الوصف**: دعم الاشتراكات السنوية مع تبديل الحساب شهرياً
**المتطلبات**:
- اشتراك بمدة محددة (سنة، 6 شهور، 3 شهور)
- تنبيهات شهرية لتسليم حساب جديد
- تسجيل تسليم كل شهر
- تنبيه الشهر التالي تلقائياً

### 9. تاب إحصائيات الشيفتات والمنتجات ✅
**الوصف**: تاب جديدة لإحصائيات تفصيلية
**المتطلبات**:
- 3 شيفتات: 4م-12م، 12م-8ص، 8ص-4م
- عدد الأوردرات لكل شيفت
- تفصيل المنتجات داخل كل شيفت
- اختيار اليوم أو نطاق تاريخ
- تصدير النتائج

### 10. تعديل نظام المصروفات ✅
**الوصف**: تحسين إدارة مصروفات الإعلانات
**المتطلبات**:
- إضافة تاريخ لكل مصروف إعلان
- إمكانية تعديل التاريخ
- حساب تكلفة الأوردر الواحد = مصروفات اليوم ÷ عدد أوردرات اليوم
- عرض التكلفة لكل يوم

### 11. ربط Google Sheets ✅
**الوصف**: مزامنة تلقائية مع Google Sheets
**المتطلبات**:
- إرسال تلقائي عند إضافة أوردر جديد
- البيانات: رقم الأوردر، التاريخ، العميل، المنتج، السعر، حالة الدفع، حالة الأوردر، نوع الأوردر، الشيفت
- تحديث عند تعديل حالة الأوردر
- API آمن يعمل في الخلفية

## بنية قاعدة البيانات المحدثة

### مجموعة Sales (الأوردرات)
```javascript
{
  id: string,
  customer_name: string,
  customer_phone: string,
  customer_email: string,
  product: string,
  price: number,
  cost: number,
  profit: number,
  status: string, // pending, completed, cancelled, replaced
  created_at: timestamp,
  confirmed_at: timestamp,
  
  // جديد: نظام التجديدات
  order_type: string, // new, renewal
  parent_order_id: string, // للتجديدات
  subscription_start: timestamp,
  subscription_end: timestamp,
  subscription_status: string, // active, expiring_soon, expired, renewed, cancelled
  auto_renew: boolean,
  
  // جديد: تتبع الدفع
  payment_status: string, // paid, partial, unpaid
  amount_paid: number,
  amount_remaining: number,
  
  // جديد: الاشتراكات طويلة المدة
  subscription_duration_months: number,
  account_change_frequency: string, // monthly, quarterly, none
  last_account_change: timestamp,
  next_account_change: timestamp,
  
  // الحقول الموجودة
  account_email: string,
  account_password: string,
  
  // جديد: استبدال الحسابات
  replaced_account: object, // {email, password, replaced_at, replaced_by}
  replacement_history: array // [{old_account, new_account, timestamp, user}]
}
```

### مجموعة Accounts (الحسابات)
```javascript
{
  id: string,
  email: string,
  password: string,
  product: string,
  status: string, // available, used, damaged
  created_at: timestamp,
  used_at: timestamp,
  expiry_date: timestamp, // جديد
  linked_order_id: string,
  notes: string
}
```

### مجموعة Notifications (التنبيهات) - جديد
```javascript
{
  id: string,
  type: string, // subscription_expiring, renewal_failed, payment_pending, account_change_due
  title: string,
  message: string,
  related_order_id: string,
  related_subscription_id: string,
  priority: string, // high, medium, low
  is_read: boolean,
  created_at: timestamp,
  action_required: boolean,
  auto_dismiss_on_action: boolean
}
```

### مجموعة Expenses (المصروفات)
```javascript
{
  id: string,
  type: string,
  amount: number,
  description: string,
  created_at: timestamp,
  expense_date: timestamp, // جديد - للإعلانات
  platform: string, // للإعلانات
  campaign_name: string
}
```

### مجموعة Audit_Logs (سجل العمليات) - جديد
```javascript
{
  id: string,
  action_type: string, // account_replaced, subscription_renewed, payment_updated
  order_id: string,
  old_value: object,
  new_value: object,
  performed_by: string,
  performed_at: timestamp,
  details: string
}
```

## خطة التنفيذ

### المرحلة 1: تحديث قاعدة البيانات
- [ ] إضافة الحقول الجديدة للأوردرات
- [ ] إضافة الحقول الجديدة للحسابات
- [ ] إنشاء مجموعة Notifications
- [ ] إنشاء مجموعة Audit_Logs
- [ ] تحديث قواعد Firestore Security

### المرحلة 2: نظام التجديدات والاشتراكات
- [ ] إضافة حقول الاشتراك في نموذج الأوردر
- [ ] تطوير دالة حساب تاريخ الانتهاء
- [ ] تطوير نظام التنبيهات (48 ساعة)
- [ ] تطوير التجديد اليدوي
- [ ] تطوير التجديد التلقائي
- [ ] ربط التجديدات بأوردرات جديدة

### المرحلة 3: واجهة الأوردرات المحسنة
- [ ] تصميم جدول Excel-like
- [ ] إضافة Highlight و Hover effects
- [ ] أزرار الإجراءات السريعة
- [ ] نظام البحث المتقدم
- [ ] الفلاتر المتعددة
- [ ] ترتيب الأعمدة
- [ ] تصدير CSV/Excel
- [ ] ألوان الحالات

### المرحلة 4: إدارة الأكونتات
- [ ] جدول الأكونتات المحسن
- [ ] عدادات الحالات
- [ ] فلاتر المنتج والحالة
- [ ] البحث والتعديل السريع

### المرحلة 5: استبدال الحسابات التالفة
- [ ] زر الاستبدال في تفاصيل الأوردر
- [ ] دالة وسم الحساب كتالف
- [ ] دالة اختيار حساب بديل
- [ ] تحديث الأوردر
- [ ] تسجيل في Audit Log
- [ ] عرض مميز للحسابات
- [ ] معالجة عدم توفر حسابات

### المرحلة 6: نظام التنبيهات
- [ ] مكون التنبيهات
- [ ] توليد تنبيهات الاشتراكات
- [ ] إزالة تلقائية عند التجديد
- [ ] تقليل العداد عند القراءة
- [ ] أنواع التنبيهات المختلفة

### المرحلة 7: تتبع الدفع
- [ ] حقول الدفع في النموذج
- [ ] حساب المبلغ المتبقي
- [ ] عرض حالة الدفع
- [ ] تحديث الإحصائيات

### المرحلة 8: الاشتراكات طويلة المدة
- [ ] حقول المدة والتبديل
- [ ] حساب مواعيد التبديل
- [ ] تنبيهات التبديل الشهري
- [ ] تسجيل التسليم

### المرحلة 9: تاب الشيفتات والمنتجات
- [ ] تصميم التاب الجديدة
- [ ] دالة حساب الشيفت من التاريخ
- [ ] إحصائيات الشيفتات
- [ ] إحصائيات المنتجات لكل شيفت
- [ ] اختيار النطاق الزمني
- [ ] تصدير النتائج

### المرحلة 10: نظام المصروفات
- [ ] حقل التاريخ للإعلانات
- [ ] تعديل التاريخ
- [ ] دالة حساب تكلفة الأوردر
- [ ] عرض التكلفة اليومية

### المرحلة 11: ربط Google Sheets
- [ ] إعداد Google Sheets API
- [ ] دالة الإرسال التلقائي
- [ ] معالجة الأخطاء
- [ ] تحديث عند التعديل

## الملفات المطلوب تعديلها

1. **app.js** - الملف الرئيسي
2. **enhanced-features.js** - الميزات المحسنة
3. **index.html** - الواجهة الرئيسية
4. **styles.css** - التنسيقات
5. **firestore.rules** - قواعد الأمان
6. **automation.js** - الأتمتة
7. **enhanced-integration.js** - التكامل

## ملاحظات مهمة

- جميع التعديلات يجب أن تكون متوافقة مع البنية الحالية
- الحفاظ على الميزات الموجودة
- اختبار شامل لكل ميزة جديدة
- توثيق كامل للكود
- واجهة عربية بالكامل
- دعم الوضع الليلي
- استجابة على جميع الأجهزة
